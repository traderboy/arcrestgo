<!DOCTYPE HTML>
<html>

<head>
    <title>ArcService JSON Editor</title>
    <link href="dist/jsoneditor.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="dist/xonomy/xonomy.js"></script>
    <link type="text/css" rel="stylesheet" href="dist/xonomy/xonomy.css" />

    <script src="dist/jsoneditor.js"></script>
    <link rel="stylesheet" href="dist/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="dist/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="dist/bootstrap-3.3.7-dist/css/bootstrap-theme.min.css">
    <script src="dist/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <!--
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
-->
    <!-- Optional theme -->
    <!--
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
-->
    <!-- Latest compiled and minified JavaScript -->
    <!--
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
-->
    <!--
    <script src="dist/vkbeautify.0.99.00.beta.js"></script>
    -->
    <script>
        function showSpinner() {
            document.getElementById("spinner").style.display = 'block'
        }

        function hideSpinner() {
            document.getElementById("spinner").style.display = 'none'
        }

        function populateDropdown() {
            var serviceUrl = location.href + (location.href.substring(location.href.length - 1) == '/' ? "" : "/") + "arcgis/rest/services"
            showSpinner()
            loadJSON(serviceUrl,
                function (data) {
                    //console.log(data);
                    //get list of folders
                    var service = data.folders[0]
                    document.getElementById("serviceUrl").value = serviceUrl + "/" + service
                    loadServices()
                    //document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Loaded service</b>"
                    //populateDropdownFromService(serviceUrl, service, data)
                },
                function (xhr) {
                    console.error(xhr);
                    showError("Service URL not found")
                    hideSpinner()
                }
            )
        }

        function xml_to_string(xml_node) {
            if (xml_node.xml)
                return xml_node.xml;
            else if (XMLSerializer) {
                var xml_serializer = new XMLSerializer();
                return xml_serializer.serializeToString(xml_node);
            }
            else {
                alert("ERROR: Extremely old browser");
                return "";
            }
        }

        function loadServices() {
            var url = document.getElementById("serviceUrl").value
            if (url == '') {
                showError("No service url!")
                return
            }
            var urlsplit = url.split("/")
            var service = urlsplit[6]
            for (var i = 0; i < urlsplit.length; i++) {
                if (urlsplit[i].toLowerCase() == 'service' && urlsplit.length > i) {
                    service = urlsplit[i + 1]
                }
            }

            var serviceUrl = urlsplit[0] + "//" + urlsplit[2]

            loadJSON(url,
                function (data) {
                    console.log(data);
                    //get list of folders
                    editor.set({});
                    showMessage("Loaded service")
                    populateDropdownFromService(serviceUrl, service, data)
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    showError("Service URL not found")
                    hideSpinner()
                }
            );

        }

        function populateDropdownInitial() {
            var select = document.getElementById("urls")
            var pre = location.host
            var langArray = [
                { "value": "", "text": "" },
                { "value": "config", "text": "Configuration" },
                //{ "value": "sharing/{rest}/accounts/self", "text": "Accounts self" },
                { "value": "/sharing/rest/portals/self", "text": "Portals self" },
                { "value": "sharing/rest/search", "text": "Search" },
                { "value": "arcgis/rest/services", "text": "Services" }
                /*
                { "value": "sharing/rest/content/items/leasecompliancefor2016", "text": "Content items" },
                { "value": "sharing/rest/content/items/leasecompliancefor2016/data", "text": "Content items data" },
                
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer", "text": "FeatureServer" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/0", "text": "FeatureServer 0" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/1", "text": "FeatureServer 1" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/2", "text": "FeatureServer 2" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/3", "text": "FeatureServer 3" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/4", "text": "FeatureServer 4" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/5", "text": "FeatureServer 5" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/6", "text": "FeatureServer 6" }
                */
            ]
            var il = langArray.length;
            var i = 0;
            var option;
            for (; i < il; i += 1) {
                option = document.createElement('option');
                option.setAttribute('value', langArray[i].value);
                option.appendChild(document.createTextNode(langArray[i].text));
                select.appendChild(option);
            }

        }

        function populateDropdownFromService(url, service, data) {
            var select = document.getElementById("urls")
            for (i = select.options.length - 1; i >= 0; i--) {
                select.remove(i);
            }
            var langArray = [
                { "value": "", "text": "" },
                { "value": url + "/config", "text": "Configuration" },
                //{ "value": url+"sharing/rest/accounts/self", "text": "Accounts self" },
                { "value": url + "/sharing/rest/portals/self?f=json", "text": "Portals self" },
                { "value": url + "/sharing/rest/search?f=json", "text": "Search" },
                { "value": url + "/sharing/rest/content/items/" + service + "?f=json", "text": "Content items" },
                { "value": url + "/sharing/rest/content/items/" + service + "/data?f=json", "text": "Content items data" },
                { "value": url + "/arcgis/rest/services?f=json", "text": "Services" },
                { "value": url + "/arcgis/rest/services/" + service + "/FeatureServer?f=json", "text": "FeatureServer" }
                /*                
                
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/0", "text": "FeatureServer 0" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/1", "text": "FeatureServer 1" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/2", "text": "FeatureServer 2" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/3", "text": "FeatureServer 3" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/4", "text": "FeatureServer 4" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/5", "text": "FeatureServer 5" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/6", "text": "FeatureServer 6" }
                */
            ]
            for (var i = 0; i < data.layers.length; i++) {
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "?f=json", "text": data.layers[i].name + " (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.layers[i].name + " ObjectID (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?f=json", "text": data.layers[i].name + " Query (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/db/" + (data.layers[i].id + 1) + "?f=json", "text": data.layers[i].name + " Db (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/xml/" + (data.layers[i].id) + "?f=json", "text": data.layers[i].name + " XML (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/table/" + data.layers[i].id, "text": data.layers[i].name + " Table (" + data.layers[i].id + ")" })
            }
            for (var i = 0; i < data.tables.length; i++) {
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "?f=json", "text": data.tables[i].name + " (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.tables[i].name + " ObjectID (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?f=json", "text": data.tables[i].name + " Query (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/db/" + (data.tables[i].id + 1) + "?f=json", "text": data.tables[i].name + " Db (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/xml/" + (data.tables[i].id) + "?f=json", "text": data.tables[i].name + " XML (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/table/" + data.tables[i].id + "?f=json", "text": data.tables[i].name + " Table (" + data.tables[i].id + ")" })

            }
            var il = langArray.length;
            var i = 0;
            var option;
            for (; i < il; i += 1) {
                option = document.createElement('option');
                option.setAttribute('value', langArray[i].value);
                option.appendChild(document.createTextNode(langArray[i].text));
                select.appendChild(option);
            }
        }

        function loadDatabase(db) {
            db = escape(db)
            var url = location.href + (location.href.substring(location.href.length - 1) == '/' ? "" : "/") + "offline"
            //var urlsplit = db.split("\\")
            //var service = urlsplit[urlsplit.length - 1]
            //for (var i = 0; i < urlsplit.length; i++) {
            //    if (urlsplit[i].toLowerCase() == 'service' && urlsplit.length > i) {
            //        service = urlsplit[i + 1]
            //    }
            // }

            //var serviceUrl = urlsplit[0] + "//" + urlsplit[2]
            var service = ""
            console.log(url + "?db=" + db)
            loadJSON(url + "?db=" + db,
                function (data) {
                    //console.log(data);
                    //get list of folders
                    editor.set({});
                    showMessage("Loaded database")
                    populateDropdownFromDatabase(url, service, data, db)
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    showError("Service URL not found")
                    hideSpinner()
                }
            );

        }

        function populateDropdownFromDatabase(url, service, data, db) {
            var select = document.getElementById("urls")
            for (i = select.options.length - 1; i >= 0; i--) {
                select.remove(i);
            }
            //GDB_ServiceItems: has JSON field: "ItemInfo"
            //GDB_Items:  has XML field:  Definition
            var langArray = [
                { "value": "", "text": "" }
                //{ "value": url + "/config", "text": "Configuration" },
                //{ "value": url+"sharing/rest/accounts/self", "text": "Accounts self" },
                //{ "value": url + "/sharing/rest/portals/self?f=json", "text": "Portals self" },
                //{ "value": url + "/sharing/rest/search?f=json", "text": "Search" },
                //{ "value": url + "/sharing/rest/content/items/" + service + "?f=json", "text": "Content items" },
                //{ "value": url + "/sharing/rest/content/items/" + service + "/data?f=json", "text": "Content items data" },
                //{ "value": url + "/arcgis/rest/services?f=json", "text": "Services" },
                //{ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer?f=json", "text": "FeatureServer" }
                /*                
                
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/0", "text": "FeatureServer 0" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/1", "text": "FeatureServer 1" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/2", "text": "FeatureServer 2" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/3", "text": "FeatureServer 3" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/4", "text": "FeatureServer 4" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/5", "text": "FeatureServer 5" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/6", "text": "FeatureServer 6" }
                */
            ]
            for (var i = 0; i < data.length; i++) {
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "?f=json", "text": data.layers[i].name + " (" + data.layers[i].id + ")" })
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.layers[i].name + " ObjectID (" + data.layers[i].id + ")" })
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?f=json", "text": data.layers[i].name + " Query (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/" + data[i][0] + "/" + data[i][1] + "/" + data[i][2] + "/" + data[i][3] + "/" + (data[i][4] ? data[i][4] : "%20") + "?db=" + db, "text": data[i][1] + "/" + data[i][4] + (data[i][6]?" (" + data[i][6] + ")":"") })
                if (data[i][1] == "GDB_ServiceItems" && data[i][5] != "0") {
                    langArray.push({ "value": url + "/table/" + data[i][1] + "/" + data[i][2] + "/" + data[i][3] + "/" + (data[i][4] ? data[i][4] : "%20") + "?db=" + db, "text": data[i][1] + "/" + data[i][4] + " (table)" })
                }
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/table/" + data.layers[i].id, "text": data.layers[i].name + " Table (" + data.layers[i].id + ")" })
            }
            /*
            for (var i = 0; i < data.tables.length; i++) {
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "?f=json", "text": data.tables[i].name + " (" + data.tables[i].id + ")" })
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.tables[i].name + " ObjectID (" + data.tables[i].id + ")" })
                //langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?f=json", "text": data.tables[i].name + " Query (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/db/" + (data.tables[i].id + 1) + "?f=json", "text": data.tables[i].name + " Db (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/table/" + data.tables[i].id + "?f=json", "text": data.tables[i].name + " Table (" + data.tables[i].id + ")" })

            }
            */
            var il = langArray.length;
            var i = 0;
            var option;
            for (; i < il; i += 1) {
                option = document.createElement('option');
                option.setAttribute('value', langArray[i].value);
                option.appendChild(document.createTextNode(langArray[i].text));
                select.appendChild(option);
            }
        }

        function updateURL(sel) {
            if (sel.value == "") {
                document.getElementById("url").value = "";
                editor.set({});
                return
            }
            if (sel.value.substring(0, 4).toLowerCase() == 'http')
                val = sel.value
            else {
                val = location.href + sel.value
            }
            var url = document.getElementById("url").value = val
            loadURL()
        }

        function loadURL() {
            var url = document.getElementById("url").value
            if (url == "") {
                showError("Enter a valid URL")
                return
            }
            document.getElementById('urlLbl').innerHTML = ""
            if (false && url.indexOf("/xml/") != -1) {
                var win = window.open(url, '_blank');
                win.focus();


                /*
                document.getElementById("jsoneditor").style.display = "none"
                document.getElementById("xmleditor").style.display = "block"
                loadXML(url,
                    function (xml) {
                        document.getElementById("xmleditor").innerHTML = vkbeautify.xml(xml,4)
                        hideSpinner()
                    },
                    function (xhr) {
                        console.error(xhr);
                        document.getElementById('urlLbl').innerHTML = "<b style='color:red'>URL not found</b>"
                        hideSpinner()
                    }
                )
                */
                return
            }

            showSpinner()
            document.getElementsByClassName("jsoneditor-tree")[0].style.display = "none"
            document.getElementById("xmleditor").style.display = "none"
            //document.getElementById("xmleditor").style.display = "none"
            document.getElementById("tableeditor").style.display = "none"
            if (url.indexOf("/xml/") != -1) {

                document.getElementById("xmleditor").style.display = "block"
                //document.getElementById("tableeditor").style.display = "none"

                //document.getElementById("jsoneditor").style.display = "none"

                //document.getElementById("jsoneditor").style.display = "none"
                //document.getElementById("xmleditor").style.display = "block"
                loadXML(url,
                    function (xml) {
                        if (xml == "") {
                            xml = "<root>Empty</root>";
                        }
                        //document.getElementById("xmleditor").innerHTML = vkbeautify.xml(xml,4)

                        var docSpec = {
                            elements: {
                                /*
                                "GPSyncReplica": {
                                    oneliner: true
                                },
                                */
                                "GPSyncReplica": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "GPSyncDataset": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "GPCodedValueDomain2": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "DETableInfo": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "DERelationshipClassInfo": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "DEWorkspace": {
                                    collapsed: function (jsElement) { return false; }
                                },
                                "DEFeatureClassInfo": {
                                    collapsed: function (jsElement) { return false; }
                                },

                                "GPHistoricalMarker": {
                                    collapsed: function (jsElement) { return false; }
                                },

                            }
                        }
                        //document.getElementById("resetJSON").style.visibility = "visible";

                        var xmleditor = document.getElementById("xmleditor");
                        Xonomy.render(xml, xmleditor, docSpec);


                        hideSpinner()
                    },
                    function (xhr) {
                        console.error(xhr);
                        document.getElementById('urlLbl').innerHTML = "<b style='color:red'>URL not found</b>"
                        hideSpinner()
                    }
                )


            }

            else if (url.indexOf("/table/") != -1) {
                loadXML(url,
                    function (data) {
                        document.getElementById("tableeditor").style.display = "block"
                        document.getElementById("tableeditor").innerHTML = data;
                        //document.getElementById("resetJSON").style.visibility = "visible";
                        hideSpinner()
                    },
                    function (xhr) {
                        showError("URL not found")
                        hideSpinner()
                    }
                );
            } else {
                loadJSON(url,
                    function (data) {
                        //console.log(data);
                        document.getElementsByClassName("jsoneditor-tree")[0].style.display = "block"
                        //document.getElementById("resetJSON").style.visibility = "hidden";
                        editor.set(data);
                        hideSpinner()
                    },
                    function (xhr) {
                        console.error(xhr);
                        showError("URL not found")
                        editor.set({});
                        hideSpinner()
                    }
                );
            }
        }
        function loadTextFile(file) {
            if (!file) {
                return;
            }
            document.getElementsByClassName("jsoneditor-tree")[0].style.display = "none"
            document.getElementById("xmleditor").style.display = "none"
            //document.getElementById("xmleditor").style.display = "none"
            document.getElementById("tableeditor").style.display = "none"

            showSpinner()
            var reader = new FileReader();
            reader.onload = function (e) {
                var contents = e.target.result;
                if (contents.charAt(0) == '<') {
                    var docSpec = {
                        elements: {
                            /*
                            "GPSyncReplica": {
                                oneliner: true
                            },
                            */
                            "GPSyncReplica": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "GPSyncDataset": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "GPCodedValueDomain2": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "DETableInfo": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "DERelationshipClassInfo": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "DEWorkspace": {
                                collapsed: function (jsElement) { return false; }
                            },
                            "DEFeatureClassInfo": {
                                collapsed: function (jsElement) { return false; }
                            },

                            "GPHistoricalMarker": {
                                collapsed: function (jsElement) { return false; }
                            },

                        }
                    }
                    //document.getElementById("resetJSON").style.visibility = "visible";

                    var xmleditor = document.getElementById("xmleditor");
                    Xonomy.render(contents, xmleditor, docSpec);
                    hideSpinner();
                    document.getElementById("xmleditor").style.display = "block"

                }
                else {
                    document.getElementsByClassName("jsoneditor-tree")[0].style.display = "block"
                    editor.set(JSON.parse(contents));
                    hideSpinner();
                }
                //displayContents(contents);
            };
            reader.readAsText(file);


        }

        function loadJSON(path, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success) {
                            success(JSON.parse(xhr.responseText));
                        }
                    } else {
                        if (error) {
                            error(xhr);
                            hideSpinner()
                        }
                    }
                }
            };
            xhr.open("GET", path, true);
            xhr.send();
        }
        function putJSON(url, txt, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success)
                            success(JSON.parse(xhr.responseText));
                    } else {
                        if (error)
                            error(xhr);
                    }
                }
            };

            xhr.open('PUT', url, true);//true: asynchronous, false: synchronous
            //xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            /*
            xhr.onload = function () {
                if (xhr.status === 200) {
                    if (success)
                        success(JSON.parse(xhr.responseText));
                } else {
                    if (error)
                        error(xhr);
                }
            };
            */
            //xhr.send(encodeURI(txt));
            xhr.send(txt);

        }
        function loadXML(path, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success) {
                            //xhr.responseXML
                            success(xhr.responseText);
                        }
                    } else {
                        if (error) {
                            error(xhr);
                        }
                    }
                }
            };
            xhr.open("GET", path, true);
            xhr.send();
        }
        function showMessage(str) {
            document.getElementById('urlLbl').innerHTML = "<b style='color:#f0ad4e'>" + str + "</b>"
        }
        function showError(str) {
            document.getElementById('urlLbl').innerHTML = "<b style='color:red'>" + str + "</b>"
        }
    </script>

    <style type="text/css">
        #jsoneditor {
            width: 100%;
            height: 100%;
            /*height: 1200px;*/
        }

        #tableeditor {
            width: 100%;
            height: 100%;
            /*height: 1200px;*/
            display: none;
            overflow: auto;
        }
        /*
        form {
            display: inline
        }
        */

        #xmleditor {
            display: none;
            width: 100%;
            height: 100%;
            /*height: 1200px;*/
            overflow: auto;
        }

        table.a {
            width: 100%;
        }

        table.a,
        th.a,
        td.a {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th.a,
        td.a {
            padding: 5px;
            text-align: left;
        }

        .btn-pad {
            padding: 10px;
            text-align: left;
            display: inline-table;
            margin-left: 10px;
        }

        #spinner {
            left: 40%;
            top: 40%;
            position: absolute;
            display: none
        }

        #urlLbl {
            margin-right: 20px;
        }


        .xonomy.nerd {
            font-size: 1em;
        }
    </style>
</head>

<body onload="populateDropdown()">

    <form class="form-inline" id='loader' name='loader' style="margin-left:2px">
        <!--<input id='url' type='text' style="width:90%">-->
        <label>URL</label>
        <input class="form-control" type="text" value="" id="url" style="width:94%">
        <button type='submit' class="btn btn-default" id="setJSON" value='URL' style="float:right">Load</button>
        <!--<button type='button' class="btn btn-default" id="resetJSON" style="visibility:hidden">Return</button>-->
    </form>


    <!--
    <iframe id="xmleditor"></iframe>

    <div id="axmleditor"></div>
    <div id="aaxmleditor">
        <textarea id="textarea" style="width:100%;height:100%"></textarea>
    </div>
-->
    <div id="jsoneditor"></div>
    <!--
    <div id="tableeditor"></div>
    <div id="xmleditor"></div>
    -->

    <img src="dist/img/spinner.gif" id='spinner'>

    <div class="modal fade" id="loadservice" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Load a service</h4>
                </div>
                <form id='svcform'>
                    <div class="modal-body">

                        <span style='width:100%;'>
            <input id='serviceUrl' type='text' style='width:100%'>
            
            </span>

                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="getSvc" class="btn btn-primary">Load service</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loaddatabase" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Load an ESRI Collector offline database</h4>
                </div>
                <form id='dbform'>
                    <div class="modal-body">

                        <div class="form-group">
                            <label for="dbFileName">Full path to .geodatabase file</label>
                            <input type="text" id="dbFileName" style="width:100%">
                            <!--
                            <input type="file" class="form-control-file" id="dbFileName" aria-describedby="fileHelp">
                            <small id="fileHelp" class="form-text text-muted">This is some placeholder block-level help text for the above input. It's a bit lighter and easily wraps to a new line.</small>
                            -->
                        </div>



                    </div>
                    <div class="modal-footer">
                        <button type="submit" id="getSvc" class="btn btn-primary">Load database</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loadfile" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Load an XML or JSON file</h4>
                </div>
                <form id='fileview'>
                    <div class="modal-body">

                        <div class="form-group">
                            <label for="textFile">File path</label>
                            <input type="file" id="textFile" class="form-control-file" style="width:500px">
                            <!--
                            <input type="file" class="form-control-file" id="dbFileName" aria-describedby="fileHelp">
                            <small id="fileHelp" class="form-text text-muted">This is some placeholder block-level help text for the above input. It's a bit lighter and easily wraps to a new line.</small>
                            -->
                        </div>



                    </div>
                    <div class="modal-footer">
                        <!--<button type="submit" id="getFile" class="btn btn-primary">Load file</button>-->
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!--

    <div class="modal fade" id="savejson" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Save changes to JSON</h4>
                </div>
                <div class="modal-body">

                    <form id='frm' style='float:right'>
                        <button type="submit" id="getJSON" class="btn btn-primary">Save JSON</button>
                        <input type='hidden' id='updatestr' name='update' value=''>
                        <input type='hidden' id='urlstr' name='url' value=''>
                    </form>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
-->
    <div class="modal fade" id="importtext" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Format JSON or XML text</h4>
                </div>
                <form name="jsonfrm" id='jsonfrm'>
                    <div class="modal-body">

                        <textarea style="width:100%;height:300px" id="jsontxt"></textarea>
                        <br> Paste JSON or XML text in box and click button to load into frame above.
                        <!--
                        <input class="form-check-input" id="jsontype" type="radio" name="type" value="JSON" checked="true">JSON
                        <input class="form-check-input" type="radio" name="type" value="XML">XML
                        -->
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-default" style='margin-left:200px' id="parseJSON">Load</button>
                        <button type="reset" class="btn btn-default">Clear</button>

                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        function loadButtons() {
            var tbl = document.getElementsByClassName("jsoneditor-search");
            if (tbl.length == 0) return;
            var tr = tbl[0].getElementsByTagName("tr");
            if (tr.length == 0) return;
            var icon = tr[0].insertCell(0);
            //icon.innerHTML = '<a id="saveChangesID" class="btn btn-default btn-pad" title="Save changes to JSON" href="path/to/settings" aria-label="Save changes"> <i class="fa fa-floppy-o fa-2x" aria-hidden="true"></i></a>';
            //icon.innerHTML = '<button id="saveChangesID" class="btn btn-default btn-pad" title="Save changes to JSON" href="path/to/settings" aria-label="Save changes"> <i class="fa fa-floppy-o fa-2x" aria-hidden="true"></i></button>';
            //data-toggle="modal" data-target="#savejson" 
            icon.innerHTML = '<a title="Save changes to JSON/XML" style="margin-right:50px" id="savejsonbtn" class="btn btn-pad" aria-label="Left Align"><i class="fa fa-floppy-o fa-2x" aria-hidden="true"></i></a>'
            document.getElementById("savejsonbtn").onclick = function () {
                saveJSON();
            }

            icon = tr[0].insertCell(0);
            //icon.innerHTML = '<a id="importTextID" class="btn btn-default btn-pad" title="View JSON or XML text" href="path/to/settings" aria-label="Import JSON/XML text"> <i class="fa fa-clipboard fa-2x" aria-hidden="true"></i></a>';
            icon.innerHTML = '<a title="Import JSON or XML text" class="btn btn-pad" data-toggle="modal" data-target="#importtext" aria-label="Left Align"><i class="fa fa-clipboard fa-2x" aria-hidden="true"></i></a>'

            icon = tr[0].insertCell(0);
            //icon.innerHTML = '<a id="setDatabaseID" class="btn btn-default btn-pad" title="Set database" href="path/to/settings" aria-label="Set database"> <i class="fa fa-database fa-2x" aria-hidden="true"></i></a>';
            icon.innerHTML = '<a title="Load data from alternative database" class="btn btn-pad" data-toggle="modal" data-target="#loaddatabase" aria-label="Left Align"><i class="fa fa-database fa-2x" aria-hidden="true"></i></a>'

            icon = tr[0].insertCell(0);
            //icon.innerHTML = '<a id="setServiceID" data-toggle="modal" data-target="#myModal" class="btn btn-default btn-pad" title="Set link to service" href="#" aria-label="Set link to service"> <i class="fa fa-link fa-2x" aria-hidden="true"></i></a>';
            icon.innerHTML = '<a title="Connect to new service" class="btn btn-pad" data-toggle="modal" data-target="#loadservice" aria-label="Left Align"><i class="fa fa-link fa-2x" aria-hidden="true"></i></a>'

            icon = tr[0].insertCell(0);
            //icon.innerHTML = '<a id="setServiceID" data-toggle="modal" data-target="#myModal" class="btn btn-default btn-pad" title="Set link to service" href="#" aria-label="Set link to service"> <i class="fa fa-link fa-2x" aria-hidden="true"></i></a>';
            icon.innerHTML = '<a title="Open a JSON/XML file" class="btn btn-pad" data-toggle="modal" data-target="#loadfile" aria-label="Left Align"><i class="fa fa-file-text fa-2x" aria-hidden="true"></i></a>'

            icon = tr[0].insertCell(0);
            icon.innerHTML = '<form class="form-inline" style="padding-right:30px;" id="urlfrm"><span id="urlLbl"></span> <span style="color:white">Source</span> <select class="form-control" style="height:30px" id="urls" onchange="updateURL(this)"></select></form>';

            document.getElementById('textFile').addEventListener('change', function (e) {
                $("[data-dismiss=modal]").trigger({ type: "click" });
                var file = e.target.files[0];
                if (!file) return;
                //console.log(e.target.files[0])
                showMessage("Viewing file: " + e.target.files[0].name)
                loadTextFile(e.target.files[0])
            }, false);
            //icon = tr[0].insertCell(0);
            //icon.innerHTML = '<div id="urlLbl"></div>'
            /*
                        document.getElementById("resetJSON").onclick = function () {
                            document.getElementsByClassName("jsoneditor-tree")[0].style.display = "block"
                            document.getElementById("tableeditor").style.display = "none"
                            this.style.visibility = "hidden";
                            var select = document.getElementById("urls")
                            select.selectedIndex = 0;
                            editor.set({});
                            //document.getElementById("url").value="";
                        }
                        */
            var ed = document.getElementsByClassName("jsoneditor-outer")
            if (ed.length == 0) return;
            ed[0].appendChild($('<div id="tableeditor"></div>')[0])
            ed[0].appendChild($('<div id="xmleditor"></div>')[0]);


            /*
            <div class="alert alert-success">
              <strong>Success!</strong> Indicates a successful or positive action.
            </div>
            
            <div class="alert alert-info">
              <strong>Info!</strong> Indicates a neutral informative change or action.
            </div>
            
            <div class="alert alert-warning">
              <strong>Warning!</strong> Indicates a warning that might need attention.
            </div>
            
            <div class="alert alert-danger">
              <strong>Danger!</strong> Indicates a dangerous or potentially negative action.
            </div>
            */
            //<span style="width:50px"></span>
            /*
            tbl = document.getElementsByClassName("jsoneditor-outer");
            if (tbl.length == 0) return;
            icon = tbl[0].insertCell(0);
            icon.innerHTML='<div id="tableeditor"></div>';
            */
        }

        function saveJSON() {
            var select = document.getElementById("urls")
            if (select.selectedIndex < 1) {
                //document.getElementById("url").value="";
                return;
            }
            var txt
            //is it XML or JSON
            if (document.getElementById("xmleditor").style.display == "block") {
                txt = Xonomy.harvest();
            }
            else if (document.getElementById("tableeditor").style.display == "block") {
                showMessage("Tables are not editable in the browser")
                return;
            }
            else if (document.getElementsByClassName("jsoneditor-tree")[0].style.display == "block") {
                txt = editor.get();
                txt = JSON.stringify(txt)
            }

            //var input_el = document.getElementById("updatestr")
            //input_el.value = JSON.stringify(json)
            var url = document.getElementById("url").value
            //var url_el = document.getElementById("urlstr")
            //url_el.value = url
            showSpinner()
            putJSON(url, txt,
                function (data) {
                    showMessage("Success")
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    showError("Error saving JSON")
                    hideSpinner()
                }
            )
        }

        // create the editor
        var container = document.getElementById('jsoneditor');
        var options = {};
        var editor = new JSONEditor(container, options);
        loadButtons();
        //window.addEventListener('load', function() {

        //})        

        // set json
        document.getElementById('loader').onsubmit = function () {
            loadURL();
            return false;
        };

        document.getElementById('dbform').onsubmit = function () {
            //loadURL();
            var db = document.getElementById("dbFileName");
            if (db.value == "") {
                showError("No database selected")
                return;
            }
            //showMessage("Loading " + db.value)
            $("[data-dismiss=modal]").trigger({ type: "click" });
            loadDatabase(db.value)
            //C:\Users\steve\AppData\Local\Packages\Esri.CollectorforArcGIS_eytg3kh68c6a8\LocalState\hpluser7_p4hlzbyr.pjw\1af029ff6b014b38bdc452a4ed09a940\kv2nifzw.rbz.geodatabase
            return false;
        };

        document.getElementById('fileview').onsubmit = function () {
            //loadURL();
            var db = document.getElementById("textFile");
            if (db.value == "") {
                showError("No file selected")
                return;
            }
            //showMessage("Loading " + db.value)
            $("[data-dismiss=modal]").trigger({ type: "click" });
            loadTextFile(db.value)
            //loadDatabase(db.value)
            //C:\Users\steve\AppData\Local\Packages\Esri.CollectorforArcGIS_eytg3kh68c6a8\LocalState\hpluser7_p4hlzbyr.pjw\1af029ff6b014b38bdc452a4ed09a940\kv2nifzw.rbz.geodatabase
            return false;
        };

        // get json
        /*
        document.getElementById('frm').onsubmit = function () {
            var json = editor.get();
            //var input_el = document.getElementById("updatestr")
            //input_el.value = JSON.stringify(json)
            var url = document.getElementById("url").value
            //var url_el = document.getElementById("urlstr")
            //url_el.value = url
            showSpinner()
            putJSON(url, JSON.stringify(json),
                function (data) {
                    document.getElementById('urlLbl').innerHTML = "<b style='color:green'>Success</b>"
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Error saving JSON</b>"
                    hideSpinner()
                }
            )

            return false


            //alert(JSON.stringify(json, null, 2));

        };
        */

        document.getElementById('svcform').onsubmit = function () {
            loadServices()
            $("[data-dismiss=modal]").trigger({ type: "click" });
            return false
        }

        document.getElementById('jsonfrm').onsubmit = function () {
            var str = document.getElementById('jsontxt').value;
            var select = document.getElementById("urls")
            select.selectedIndex = 0;
            document.getElementById("url").value = "";
            $("[data-dismiss=modal]").trigger({ type: "click" });

            var isXML = false;
            //var isXML = document.querySelector('input[name="type"]:checked').value == "XML"
            if (str.charAt(0) == '<') isXML = true;

            if (isXML) { //document.getElementById("jsontype").value == true) {
                //document.getElementById("xmleditor").style.display = "block";
                //document.getElementById("xmleditor").src="/xml?xml="+escape(str);
                //document.getElementById("xmleditor").src='data:text/xml,' + encodeURI(str); //'<x m="l"/>');

                //var url = "/xml?xml=" + encodeURI(str);
                //var win = window.open(url, '_blank');
                //win.focus();
                document.getElementById("xmleditor").style.display = "block"
                document.getElementById("tableeditor").style.display = "none"

                document.getElementsByClassName("jsoneditor-tree")[0].style.display = "none"
                var docSpec = {
                    elements: {
                        /*
                        "GPSyncReplica": {
                            oneliner: true
                        },
                        */
                        "GPSyncReplica": {
                            collapsed: function (jsElement) { return false; }
                        }
                    }
                }
                //document.getElementById("resetJSON").style.visibility = "visible";

                var xmleditor = document.getElementById("xmleditor");
                Xonomy.render(str, xmleditor, docSpec);



                //str = vkbeautify.xml(str, 4);
                //str =  str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                //document.getElementById("xmleditor").innerHTML = "<xmp>"+str+"</xmp>";
                //document.getElementById("xmleditor").innerHTML ="<pre lang=\"xml\">"+ str + "</pre>";
                //document.getElementById("textarea").value="<pre lang=\"xml\">"+ str + "</pre>";
                //document.getElementById("textarea").value=vkbeautify.xml(str, 4);


            }
            else {
                //document.getElementById("jsoneditor").style.display = "none"
                //document.getElementById("xmleditor").style.display = "none"
                document.getElementById("xmleditor").style.display = "none"
                document.getElementById("tableeditor").style.display = "none"

                document.getElementsByClassName("jsoneditor-tree")[0].style.display = "block"
                try {
                    var obj = JSON.parse(str);
                    editor.set(obj);
                } catch (e) { }
            }
            return false
        }
    </script>
</body>

</html>