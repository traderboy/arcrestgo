<!DOCTYPE HTML>
<html>

<head>
    <title>ArcService JSON Editor</title>

    <link href="dist/jsoneditor.css" rel="stylesheet" type="text/css">
    <script src="dist/jsoneditor.js"></script>
    <script src="dist/vkbeautify.0.99.00.beta.js"></script>
    <script>
        function showSpinner() {
            document.getElementById("spinner").style.display = 'block'
        }
        function hideSpinner() {
            document.getElementById("spinner").style.display = 'none'
        }
        function populateDropdown() {
            var serviceUrl = location.href + (location.href.substring(location.href.length - 1) == '/' ? "" : "/") + "arcgis/rest/services"
            showSpinner()
            loadJSON(serviceUrl,
                function (data) {
                    //console.log(data);
                    //get list of folders
                    var service = data.folders[0]
                    document.getElementById("serviceUrl").value = serviceUrl + "/" + service
                    loadServices()
                    //document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Loaded service</b>"
                    //populateDropdownFromService(serviceUrl, service, data)
                },
                function (xhr) {
                    console.error(xhr);
                    document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Service URL not found</b>"
                    hideSpinner()
                }
            )

        }
        function xml_to_string(xml_node) {
            if (xml_node.xml)
                return xml_node.xml;
            else if (XMLSerializer) {
                var xml_serializer = new XMLSerializer();
                return xml_serializer.serializeToString(xml_node);
            }
            else {
                alert("ERROR: Extremely old browser");
                return "";
            }
        }

        function loadServices() {
            var url = document.getElementById("serviceUrl").value
            if (url == '') {
                document.getElementById('urlLbl').innerHTML = "<b style='color:red'>No service url!</b>"
                return
            }
            var urlsplit = url.split("/")
            var service = urlsplit[6]
            for (var i = 0; i < urlsplit.length; i++) {
                if (urlsplit[i].toLowerCase() == 'service' && urlsplit.length > i) {
                    service = urlsplit[i + 1]
                }
            }

            var serviceUrl = urlsplit[0] + "//" + urlsplit[2]

            loadJSON(url,
                function (data) {
                    console.log(data);
                    //get list of folders
                    editor.set({});
                    document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Loaded service</b>"
                    populateDropdownFromService(serviceUrl, service, data)
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Service URL not found</b>"
                    hideSpinner()
                }
            );

        }
        function populateDropdownInitial() {
            var select = document.getElementById("urls")
            var pre = location.host
            var langArray = [
                { "value": "", "text": "" },
                { "value": "config", "text": "Configuration" },
                //{ "value": "sharing/{rest}/accounts/self", "text": "Accounts self" },
                { "value": "/sharing/rest/portals/self", "text": "Portals self" },
                { "value": "sharing/rest/search", "text": "Search" },
                { "value": "arcgis/rest/services", "text": "Services" }
                /*
                { "value": "sharing/rest/content/items/leasecompliancefor2016", "text": "Content items" },
                { "value": "sharing/rest/content/items/leasecompliancefor2016/data", "text": "Content items data" },
                
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer", "text": "FeatureServer" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/0", "text": "FeatureServer 0" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/1", "text": "FeatureServer 1" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/2", "text": "FeatureServer 2" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/3", "text": "FeatureServer 3" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/4", "text": "FeatureServer 4" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/5", "text": "FeatureServer 5" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/6", "text": "FeatureServer 6" }
                */
            ]
            var il = langArray.length;
            var i = 0;
            var option;
            for (; i < il; i += 1) {
                option = document.createElement('option');
                option.setAttribute('value', langArray[i].value);
                option.appendChild(document.createTextNode(langArray[i].text));
                select.appendChild(option);
            }

        }
        function populateDropdownFromService(url, service, data) {
            var select = document.getElementById("urls")
            for (i = select.options.length - 1; i >= 0; i--) {
                select.remove(i);
            }
            var langArray = [
                { "value": "", "text": "" },
                { "value": url + "/config", "text": "Configuration" },
                //{ "value": url+"sharing/rest/accounts/self", "text": "Accounts self" },
                { "value": url + "/sharing/rest/portals/self?f=json", "text": "Portals self" },
                { "value": url + "/sharing/rest/search?f=json", "text": "Search" },
                { "value": url + "/sharing/rest/content/items/" + service + "?f=json", "text": "Content items" },
                { "value": url + "/sharing/rest/content/items/" + service + "/data?f=json", "text": "Content items data" },
                { "value": url + "/arcgis/rest/services?f=json", "text": "Services" },
                { "value": url + "/arcgis/rest/services/" + service + "/FeatureServer?f=json", "text": "FeatureServer" }
                /*                
                
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/0", "text": "FeatureServer 0" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/1", "text": "FeatureServer 1" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/2", "text": "FeatureServer 2" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/3", "text": "FeatureServer 3" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/4", "text": "FeatureServer 4" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/5", "text": "FeatureServer 5" },
                { "value": "arcgis/rest/services/leasecompliancefor2016/FeatureServer/6", "text": "FeatureServer 6" }
                */
            ]
            for (var i = 0; i < data.layers.length; i++) {
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "?f=json", "text": data.layers[i].name + " (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.layers[i].name + " ObjectID (" + data.layers[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.layers[i].id + "/query?f=json", "text": data.layers[i].name + " Query (" + data.layers[i].id + ")" })
            }
            for (var i = 0; i < data.tables.length; i++) {
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "?f=json", "text": data.tables[i].name + " (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?returnGeometry=false&outFields=OBJECTID&f=json", "text": data.tables[i].name + " ObjectID (" + data.tables[i].id + ")" })
                langArray.push({ "value": url + "/arcgis/rest/services/" + service + "/FeatureServer/" + data.tables[i].id + "/query?f=json", "text": data.tables[i].name + " Query (" + data.tables[i].id + ")" })

            }
            var il = langArray.length;
            var i = 0;
            var option;
            for (; i < il; i += 1) {
                option = document.createElement('option');
                option.setAttribute('value', langArray[i].value);
                option.appendChild(document.createTextNode(langArray[i].text));
                select.appendChild(option);
            }
        }

        function updateURL(sel) {
            if (sel.value.substring(0, 4).toLowerCase() == 'http')
                val = sel.value
            else {
                val = location.href + sel.value
            }
            var url = document.getElementById("url").value = val
            loadURL()
        }

        function loadURL() {
            var url = document.getElementById("url").value
            if (url == "") {
                document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Enter a valid URL</b>"
                return
            }
            document.getElementById('urlLbl').innerHTML = ""
            showSpinner()
            if (url.indexOf("/xml/") != -1) {
                var win = window.open(url, '_blank');
                win.focus();
                /*
                document.getElementById("jsoneditor").style.display = "none"
                document.getElementById("xmleditor").style.display = "block"
                loadXML(url,
                    function (xml) {
                        document.getElementById("xmleditor").innerHTML = vkbeautify.xml(xml,4)
                        hideSpinner()
                    },
                    function (xhr) {
                        console.error(xhr);
                        document.getElementById('urlLbl').innerHTML = "<b style='color:red'>URL not found</b>"
                        hideSpinner()
                    }
                )
                */
                return
            }
            document.getElementById("jsoneditor").style.display = "block"
            document.getElementById("xmleditor").style.display = "none"

            loadJSON(url,
                function (data) {
                    console.log(data);
                    editor.set(data);
                    hideSpinner()
                },
                function (xhr) {
                    console.error(xhr);
                    document.getElementById('urlLbl').innerHTML = "<b style='color:red'>URL not found</b>"
                    editor.set({});
                    hideSpinner()
                }
            );
        }

        function loadJSON(path, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success) {
                            success(JSON.parse(xhr.responseText));
                        }
                    } else {
                        if (error) {
                            error(xhr);
                            hideSpinner()
                        }
                    }
                }
            };
            xhr.open("GET", path, true);
            xhr.send();
        }
        function putJSON(url, txt, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success)
                            success(JSON.parse(xhr.responseText));
                    } else {
                        if (error)
                            error(xhr);
                    }
                }
            };

            xhr.open('PUT', url, true);//true: asynchronous, false: synchronous
            //xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            /*
            xhr.onload = function () {
                if (xhr.status === 200) {
                    if (success)
                        success(JSON.parse(xhr.responseText));
                } else {
                    if (error)
                        error(xhr);
                }
            };
            */
            //xhr.send(encodeURI(txt));
            xhr.send(txt);

        }  
        function loadXML(path, success, error) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        if (success) {
                            //xhr.responseXML
                            success(xhr.responseText);
                        }
                    } else {
                        if (error) {
                            error(xhr);
                        }
                    }
                }
            };
            xhr.open("GET", path, true);
            xhr.send();
        }         
    </script>

<style type="text/css">
    #jsoneditor {
      width: 100%;
      height: 1200px;
    }
    form{display:inline}
    #xmleditor{
      display:none;
      width: 100%;
      height: 1200px;
    }
  </style>
</head>

<body onload="populateDropdown()">

<div>
    <form id='loader' name='loader'>
        <input type='submit' id="setJSON" value='URL'></input>
        <input id='url' type='text' style='width:30%'>
</form>

<form id='urlfrm'>
    <select id="urls" onchange="updateURL(this)">
</select>
</form>

<form id='svcform'>
    <span style='width:100%;margin-left:50px'>
<input id='serviceUrl' type='text' style='width:350px'>
<input type='submit' id="getSvc" value='Load service'></input>
</span>
</form>
<img src="dist/img/spinner.gif" id='spinner' style='left:40%;top:40%;position:absolute;display:none'>

<form id='frm' style='float:right'>
<input type='submit' style='float:right' id="getJSON" value='Save JSON'></input>
<input type='hidden' id='updatestr' name='update' value=''>
<input type='hidden' id='urlstr' name='url' value=''>
</form>

<span id="urlLbl"></span>
</div>


<div id="axmleditor"></div>
<div id="xmleditor">
</div>
<div id="jsoneditor"></div>

<script>
                                // create the editor
                                var container = document.getElementById('jsoneditor');
                                var options = {};
                                var editor = new JSONEditor(container, options);

                                // set json
                                document.getElementById('loader').onsubmit = function () {
                                    loadURL()
                                    return false
                                };

                                // get json
                                document.getElementById('frm').onsubmit = function () {
                                    var json = editor.get();
                                    //var input_el = document.getElementById("updatestr")
                                    //input_el.value = JSON.stringify(json)
                                    var url = document.getElementById("url").value
                                    //var url_el = document.getElementById("urlstr")
                                    //url_el.value = url
                                    showSpinner()
                                    putJSON(url, JSON.stringify(json),
                                        function (data) {
                                            document.getElementById('urlLbl').innerHTML = "<b style='color:green'>Success</b>"
                                            hideSpinner()
                                        },
                                        function (xhr) {
                                            console.error(xhr);
                                            document.getElementById('urlLbl').innerHTML = "<b style='color:red'>Error saving JSON</b>"
                                            hideSpinner()
                                        }
                                    )

                                    return false


                                    //alert(JSON.stringify(json, null, 2));

                                };
                                document.getElementById('svcform').onsubmit = function () {
                                    loadServices()
                                    return false
                                }
</script>
</body>

</html>